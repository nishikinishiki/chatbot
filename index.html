<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LINE風チャットボットフォーム</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  /* 基本的なスタイルリセット */
  *,
  *::before,
  *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    height: 100%;
    overflow: hidden;
    font-family: 'Roboto', "Helvetica Neue", "Segoe UI", "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, Arial, sans-serif;
    color: #333;
  }

  body {
    background-color: #8297ac;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .chat-container {
    width: 100%;
    height: 100vh;
    max-width: 420px;
    background-color: #ffffff;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  @media (max-width: 420px) {
    .chat-container {
      border-radius: 0;
      box-shadow: none;
      max-width: 100%;
    }
  }

  .chat-header {
    background-color: #06C755;
    color: white;
    padding: 10px 16px;
    text-align: center;
    font-size: 1.1em;
    font-weight: 500;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .chat-header-title {
    margin-bottom: 5px;
  }
  .progress-bar-container {
    width: 80%;
    height: 8px;
    background-color: #00823f;
    border-radius: 4px;
    overflow: hidden;
  }
  .progress-bar {
    width: 0%;
    height: 100%;
    background-color: #ffffff;
    border-radius: 4px;
    transition: width 0.3s ease-in-out;
  }


  .chat-messages {
    flex-grow: 1;
    padding: 16px 12px;
    overflow-y: auto;
    background-color: #e9ebee;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .message-wrapper {
    display: flex;
    width: 100%;
    align-items: flex-end;
  }

  .bot-message-wrapper {
    justify-content: flex-start;
  }
  .bot-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 8px;
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
    background-color: #ddd;
  }

  .user-message-wrapper {
    justify-content: flex-end;
  }

  .message {
    max-width: calc(100% - 48px);
    padding: 10px 14px;
    border-radius: 18px;
    line-height: 1.5;
    word-wrap: break-word;
    font-size: 0.95em;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  .bot-message-wrapper .message {
     max-width: calc(85% - 48px);
  }

  .bot-message {
    background-color: #ffffff;
    color: #212121;
    border-bottom-left-radius: 4px;
  }
  .bot-message.error-text {
    color: red;
  }


  .user-message {
    background-color: #8DE047;
    color: #000000;
    border-bottom-right-radius: 4px;
  }

  .choices-area-wrapper {
    width: 100%;
    display: flex;
    justify-content: center;
    margin-top: 8px;
    margin-bottom: 8px;
  }

  .choices-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    width: 100%;
    max-width: 380px;
    padding: 0 5px;
    max-height: 220px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }


  .choice-button {
    background-color: #fff;
    border: 1px solid #06C755;
    color: #06C755;
    padding: 10px 8px;
    border-radius: 16px;
    cursor: pointer;
    text-align: center;
    font-size: 0.85em;
    transition: background-color 0.2s, color 0.2s;
    width: 100%;
    box-sizing: border-box;
    word-break: keep-all;
    white-space: normal;
  }
  .choice-button:hover:not(:disabled) {
    background-color: #e6f8ee;
  }
  .choice-button.selected {
    background-color: #06C755;
    color: #fff;
  }
  .choice-button:disabled {
    background-color: #f0f0f0;
    color: #aaa;
    border-color: #ddd;
    cursor: not-allowed;
  }
  .submit-choices-button-wrapper {
    grid-column: 1 / -1;
    display: flex;
    justify-content: center;
    margin-top: 8px;
  }
  .submit-choices-button {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
  }
  .submit-choices-button:hover:not(:disabled) {
    background-color: #0056b3;
  }

  .final-consent-message-area {
    margin-top: 10px;
  }
  .final-consent-checkbox-area {
    font-size: 0.8em;
    margin-top: 10px;
    margin-bottom: 10px;
    text-align: left;
    padding: 0 10px;
  }
  .final-consent-checkbox-area input[type="checkbox"] {
    margin-right: 5px;
    vertical-align: middle;
  }
  .final-consent-checkbox-area label {
    vertical-align: middle;
  }
  .final-consent-checkbox-area a {
    color: #007bff;
    text-decoration: underline;
  }

  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.6); display: none;
    justify-content: center; align-items: center; z-index: 1000;
  }
  .modal-content {
    background-color: white; padding: 25px; border-radius: 8px;
    width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;
    position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }
  .modal-close-button {
    position: absolute; top: 10px; right: 15px; font-size: 1.8em;
    font-weight: bold; cursor: pointer; border: none; background: none; color: #888;
  }
  .modal-close-button:hover { color: #000; }
  .modal-content h3 { margin-top: 0; margin-bottom: 15px; font-size: 1.2em; }
  .modal-content p, .modal-content li { font-size: 0.85em; line-height: 1.6; margin-bottom: 10px; }


  .input-area {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    background-color: #f5f5f5;
    border-top: 1px solid #e0e0e0;
    min-height: 56px;
    flex-shrink: 0;
  }
  .input-area input[type="text"],
  .input-area input[type="email"],
  .input-area input[type="number"],
  .input-area input[type="tel"],
  .input-area input[type="date"] {
    flex-grow: 1;
    padding: 10px 16px;
    border: 1px solid #d0d0d0;
    border-radius: 20px;
    margin-right: 8px;
    font-size: 16px;
    outline: none;
    -webkit-appearance: none;
    appearance: none;
  }
  .input-area input[type="text"]:focus,
  .input-area input[type="email"]:focus,
  .input-area input[type="number"]:focus,
  .input-area input[type="tel"]:focus,
  .input-area input[type="date"]:focus {
    border-color: #06C755;
    box-shadow: 0 0 0 2px rgba(6, 199, 85, 0.2);
  }
  .input-area button#sendButton {
    padding: 0;
    width: 40px;
    height: 40px;
    background-color: #06C755;
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s ease;
    flex-shrink: 0;
  }
  .input-area button#sendButton svg {
    width: 20px;
    height: 20px;
  }
  .input-area button#sendButton:hover {
    background-color: #05a546;
  }
  .input-area button#sendButton:disabled {
    background-color: #b0b0b0;
    cursor: not-allowed;
  }
  .input-error {
    border-color: #ff3b30 !important;
  }
  .error-message {
    color: #ff3b30;
    font-size: 0.8em;
    margin-top: 4px;
    padding-left: 16px;
  }
</style>
</head>
<body>

<div class="chat-container">
  <div class="chat-header">
    <div class="chat-header-title">J.P.Returns お問い合わせ担当</div>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
  </div>
  <div class="chat-messages" id="chatMessages">
    </div>
  <div class="input-area" id="normalInputArea">
    <input type="text" id="userInput" placeholder="ここに入力">
    <button id="sendButton">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
    </button>
  </div>
  </div>

<div class="modal-overlay" id="giftTermsModal">
  <div class="modal-content">
    <button class="modal-close-button" id="modalCloseButton">&times;</button>
    <h3 id="modalTitle">えらべるデジタルギフトプレゼント条件</h3>
    <div id="modalBody">
      </div>
  </div>
</div>


<script src="config.js"></script>

<script>
  const chatMessages = document.getElementById('chatMessages');
  const userInput = document.getElementById('userInput');
  const sendButton = document.getElementById('sendButton');
  const progressBar = document.getElementById('progressBar');
  const normalInputArea = document.getElementById('normalInputArea');

  const giftTermsModal = document.getElementById('giftTermsModal');
  const modalCloseButton = document.getElementById('modalCloseButton');
  const modalBody = document.getElementById('modalBody');


  let currentStep = 0;
  let subStep = 0;
  const userResponses = {};
  let isBotTyping = false;
  let currentMultipleChoices = [];
  let activeChoicesWrapper = null;
  let completedEffectiveQuestions = 0;

  const katakanaRegex = /^[ァ-ヶー　]+$/;
  const questions = [
    // Q1-Q15 は前回同様
    { id: 1, item: "職業", question: "ご職業を教えてください。", answer_method: "single-choice", options: ["会社員（上場企業）", "会社員（その他）", "公務員", "経営者", "士業（医師、看護師、弁護士、税理士など）", "自営業・その他"], key: "occupation_new", validation: (v) => !!v, errorMessage: "選択してください。" },
    { id: 2, item: "年収", question: "現在の年収を教えてください。", answer_method: "single-choice", options: ["0～399万", "400～499万", "500～599万", "600～699万", "700～799万", "800～899万", "900～999万", "1000～1099万", "1100～1199万", "1200～1299万", "1300～1399万", "1400～1499万", "1500～1999万", "2000～2499万", "2500～2999万", "3000～3999万", "4000～4999万", "5000万～1億未満", "1億以上"], key: "annual_income_new", validation: (v) => !!v, errorMessage: "選択してください。" },
    { id: 3, item: "年齢", question: "ご年齢を教えてください。", answer_method: "single-choice", options: ["20歳未満", "20～24歳", "25～29歳", "30～34歳", "35～39歳", "40～44歳", "45～49歳", "50～54歳", "55～59歳", "60～64歳", "65～69歳", "70歳以上"], key: "age_group_new", validation: (v) => !!v, errorMessage: "選択してください。" },
    { id: 4, item: "名前", question: "お名前を教えてください。", answer_method: "text-multi", sub_questions: [
        {label:"姓", key:"last_name_new", validation: (v) => v && v.trim().length > 0, errorMessage: "姓を入力してください。"},
        {label:"名", key:"first_name_new", validation: (v) => v && v.trim().length > 0, errorMessage: "名を入力してください。"},
        {label:"セイ (全角カタカナ)", key:"last_name_kana_new", validation: (v) => v && katakanaRegex.test(v.trim()), errorMessage: "セイを全角カタカナで入力してください。"},
        {label:"メイ (全角カタカナ)", key:"first_name_kana_new", validation: (v) => v && katakanaRegex.test(v.trim()), errorMessage: "メイを全角カタカナで入力してください。"}
      ], key: "full_name_dummy_new" },
    { id: 5, item: "電話番号", question: "電話番号を入力してください。(例: 09012345678)", answer_method: "text", type: "tel", key: "phone_number_new", validation: (v) => /^[0-9]{10,11}$/.test(v.replace(/-/g, "")), errorMessage: "有効な電話番号をハイフンなし半角数字で入力してください。" },
    { id: 6, item: "メールアドレス", question: "メールアドレスを入力してください！(例: user@example.com)", answer_method: "text", type: "email", key: "email_address_new", validation: (v) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v), errorMessage: "有効なメールアドレスを入力してください。" },
    { id: 7, item: "面談希望", question: "ご面談を希望されますか？", answer_method: "single-choice", options: ["はい", "いいえ"], key: "interview_preference", validation: (v) => !!v, errorMessage: "選択してください。" },
    { id: 8, item: "相談希望日_第一希望", question: "【第一希望】ご相談希望日をお選びください (例: 2024/05/15)", answer_method: "text", type: "text", placeholder: "YYYY/MM/DD", key: "first_choice_date_new", condition: { key: "interview_preference", value: "はい" }, validation: (v) => /^\d{4}\/(0?[1-9]|1[0-2])\/(0?[1-9]|[12][0-9]|3[01])$/.test(v) && !isNaN(new Date(v)), errorMessage: "YYYY/MM/DD形式で有効な日付を入力してください。" },
    { id: 9, item: "相談希望時間_第一希望", question: "【第一希望】ご相談希望時間をお選びください", answer_method: "single-choice", options: ["10：00～12：00", "12：00～14：00", "14：00～16：00", "16：00～18：00", "18：00～20：00", "20：00 以降", "その他の時間"], key: "first_choice_time_new", condition: { key: "interview_preference", value: "はい" }, validation: (v) => !!v, errorMessage: "選択してください。" },
    { id: 10, item: "相談希望時間_第一希望_その他", question: "【第一希望】その他のご相談希望時間を入力ください", answer_method: "text", type: "text", key: "first_choice_time_other_new", condition: { key: "first_choice_time_new", value: "その他の時間" }, validation: (v) => v && v.trim().length > 0, errorMessage: "希望時間を入力してください。" },
    { id: 11, item: "相談希望日_第二希望", question: "【第二希望】ご相談希望日をお選びください (例: 2024/05/16)", answer_method: "text", type: "text", placeholder: "YYYY/MM/DD", key: "second_choice_date_new", condition: { key: "interview_preference", value: "はい" }, validation: (v) => /^\d{4}\/(0?[1-9]|1[0-2])\/(0?[1-9]|[12][0-9]|3[01])$/.test(v) && !isNaN(new Date(v)), errorMessage: "YYYY/MM/DD形式で有効な日付を入力してください。" },
    { id: 12, item: "相談希望時間_第二希望", question: "【第二希望】ご相談希望時間をお選びください", answer_method: "single-choice", options: ["10：00～12：00", "12：00～14：00", "14：00～16：00", "16：00～18：00", "18：00～20：00", "20：00 以降", "その他の時間"], key: "second_choice_time_new", condition: { key: "interview_preference", value: "はい" }, validation: (v) => !!v, errorMessage: "選択してください。" },
    { id: 13, item: "相談希望時間_第二希望_その他", question: "【第二希望】その他のご相談希望時間を入力ください", answer_method: "text", type: "text", key: "second_choice_time_other_new", condition: { key: "second_choice_time_new", value: "その他の時間" }, validation: (v) => v && v.trim().length > 0, errorMessage: "希望時間を入力してください。" },
    { id: 14, item: "質問要望", question: "ご質問・ご要望があれば記載ください", answer_method: "single-choice", options: ["なし", "その他（自由記述）"], key: "inquiry_text_new", condition: { key: "interview_preference", value: "いいえ" }, validation: (v) => !!v, errorMessage: "選択してください。" },
    { id: 15, item: "質問要望詳細", question: "ご質問・ご要望の詳細を自由にご記入ください。", answer_method: "text", type: "text", placeholder: "自由にご記入ください", key: "inquiry_text_detail_new", condition: { key: "inquiry_text_new", value: "その他（自由記述）" }, validation: (v) => v && v.trim().length > 0, errorMessage: "詳細を入力してください。" },
    { id: 16, item: "最終同意", question: "個人情報のお取り扱いをご確認の上、「同意して送信」を押してください。", answer_method: "final-consent",
      privacy_policy_link_text: "個人情報のお取り扱い", privacy_policy_url: "https://jpreturns.com/privacypolicy/",
      gift_terms_link_text: "えらべるデジタルギフトプレゼント条件",
      gift_terms_popup_content: `<h3>えらべるデジタルギフトプレゼント条件</h3>
        <p>【個別面談・Web面談をお申込みのお客様】<br>プレゼントは、web面談で20,000円、オフライン個別相談で50,000円相当のえらべるデジタルギフトを予定しております。面談でえらべるデジタルギフトプレゼントは以下の条件を満たした方が対象となります。なお、web面談、個別相談とは当社のコンサルタントと当社オフィスもしくは当社オフィス外、ウェブ通信にて対面し、当社サービスの十分な説明とお客様についての十分な（数回にわたり）情報を相互に交換したことを指します。<br>また、えらべるデジタルギフトではAmazonギフトカード、PayPayポイント、楽天ポイント（期間限定ポイント※）からご希望の1種のみを選択いただけます。<br>ご希望のポイントは、フォームの「ご質問・ご要望」欄に記入ください。お申し込み時にご記入がない場合は、Amazonギフトカードをプレゼントいたします。お申し込み完了後の変更は原則受け付けておりませんので、予めご了承ください。<br>※獲得いただけるポイントは期間限定ポイントになり、有効期限はポイント獲得後、6ヶ月間です。</p>
        <p><strong>プレゼント条件</strong><br>下記のすべての項⽬を満たしている⽅が対象になります。<br>
        世帯で初めて「J.P.リターンズ」のサービスを利⽤（セミナー受講、プライベートセミナー、⾯談、資料請求、動画セミナー）する⽅<br>
        予約申込後、90⽇以内に個別相談を完了された⽅（本⼈確認必須。Web⾯談の場合、カメラON、お顔が⾒える状態で⾯談をお願いします。）<br>
        ⾯談(web以外も含め)に3回以上ご参加いただいた⽅<br>
        ※お客様のご状況や提案状況に応じて、複数回の⾯談を実施する場合がございます。<br>
        上場企業、それに準ずる企業（＝資本⾦1億円以上）、またはそのグループ会社にお勤めの⽅、もしくは医師、公務員、看護師、薬剤師として現在お勤めの⽅<br>
        年収700万円以上の方<br>
        勤続年数が2年以上かつ25歳以上50歳未満の方<br>
        ※主婦、パートの⽅は配偶者の年収が700万円以上の場合、「年収700万円以上の⽅」と判断する場合もございます。<br>
        フォームよりお申込後、メールでお送りした属性アンケートにご回答頂いた内容、もしくは、営業担当がヒアリングした内容が上記の年収、勤続年数などの条件を満たした⽅<br>
        事前に「社会健康保険証」をご提出いただいた方(データ送付・もしくは画面にて提示)<br>
        WebカメラやFacetime等、テレビ通話を通じて対面で面談が出来る方（お顔を隠さず、Face to Faceで面談できる方）<br>
        当社提携金融機関の融資が受けられる方（ローン審査通過が必須）<br>
        ⾯談前の電話及び⾯談中の質問事項にすべてお答えいただけた⽅<br>
        ※ご融資に必要な質問事項、および当社のサービス提供にあたり必要な質問事項を含む<br>
        現在の社会環境の中で、前向きに購⼊を検討されている⽅</p>
        <p><strong>プレゼント対象外</strong><br>
        ご本人以外の面談の場合<br>
        1世帯で2回以上の申込みの場合<br>
        虚偽、重複、悪戯、迷惑行為、不正申込、連絡が取れない方、個別面談を受けられない方<br>
        当社で行なっている他キャンペーンに応募したことがある方<br>
        同業他社にお勤めの方<br>
        無職、学生、フリーター・パート・アルバイト、契約・派遣社員の方<br>
        現在の借り入れ状況や相談内容等によりサービスの提供が出来ない場合<br>
        自営業の方、既に住宅ローンがある、疾病などの御理由により、ローンが組めない場合（ローンのご提案が難しい場合）<br>
        Web参加されても途中退席される方<br>
        (web以外も含め)ご面談が複数回になる場合がある事をご了承いただけない場合<br>
        十分な面談時間が取れない場合(1回の面談につき、1～2時間程度)<br>
        ⾯談中、明らかに当社コンサルタントと対話する姿勢でない場合<br>
        お申込後、事前に「社会健康保険証」をデータ送付頂けない方（または、当日、画面にて呈示頂けない方）<br>
        お申込後の事前の内容確認およびご融資に必要な質問事項に対して情報を秘匿される等、ご提案へ⾮協⼒的と判断される⽅<br>
        過度に⾯談スケジュールのキャンセルや変更等をされる他、営業担当者からの連絡に対してご連絡が繋がらない等、営業担当者からの情報提供に対し協⼒的でないと判断される場合<br>
        不動産購入に対して決裁権がご自身にない場合またはご相談が必要な場合、決裁権のある方またはご相談者（配偶者等）同席での面談を別途実施出来ると確認できない方<br>
        当社の提案を全て聴いていただけた上で、不動産購⼊に対して決裁権がご⾃⾝にあり、ご⾃⾝だけで判断できると確認できない⽅<br>
        不動産投資に興味がないなど特典⽬当てと当社が判断した場合<br>
        初回の⾯談から30⽇以上次回の⾯談⽇程がとれない場合<br>
        えらべるデジタルギフトのプレゼント対象は2024年5月15日以降申し込みの方に限ります。（2024年5月14日以前に申し込みの方はAmaonギフトカード）</p>
        <p><strong>【ご⾯談についての注意事項】</strong><br>
        今現在、不動産投資を検討されていない⽅は、お申し込みをご遠慮ください。<br>
        以下に当てはまる場合に関してはご⾯談をお断り・キャンセルさせていただく可能性がございます。予めご了承の上でお申し込みください。<br>
        情報収集のみを⽬的とされる等、不動産を活⽤した資産形成やマンション経営を検討されていないと判断される場合<br>
        当社で取り扱いの無い投資⼿法やサービスをご希望される場合<br>
        ※投資条件（取り扱いエリア・物件種別・平均利回りなど）に当てはまらない場合<br>
         ※ご希望される内容が、当社の商品やサービスにマッチしない場合<br>
        具体的な話やシミュレーションのご提⽰が不要という⽅<br>
        現在の不動産市況・ご⾃⾝の所得状況と乖離のある要求をされる⽅<br>
        現在の借り⼊れ状況や相談内容等によりサービスの提供が出来ない、ローンのご提案が難しい場合<br>
        客観的に「ポイントのみが⽬当て」と判断される⾔動や⾏動をされる⽅</p>
        <p><strong>【その他注意事項】</strong><br>
        本キャンペーンはJ.P.RETURNS株式会社による提供です。本キャンペーンについてのお問い合わせはAmaon・PayPay・楽天でお受けしておりません。J.P.RETURNS株式会社 キャンペーン事務局（03‐5962‐9450）までお願いいたします。<br>
        Amazon、Amazon.co.jpおよびそれらのロゴはAmazon.com,Inc.またはその関連会社の商標です。<br>
        PayPay ギフトカードで付与。PayPay/PayPay カード公式ストアでも利用可能です。出金・譲渡不可になります。<br>
        お申し込み前に、必ずページ内に記載の「取り扱い商品の特徴」をご確認ください。<br>
        上記条件を全て満たしていなくても、ご成約後、特典を進呈する場合があります。なお、この場合、付与決定までは「付与保留」の取り扱いとさせていただきますので、ご了承ください。<br>
        （例）<br>
        ・現⾦で投資⽤不動産をご購⼊いただけた⽅<br>
        ・頭⾦として現⾦をお⽀払いいただくことにより、投資⽤不動産をご購⼊いただけた⽅<br>
        ・年収700万円未満または勤続2年未満でも、当社提携の⾦融機関から融資を受け、投資⽤不動産をご購⼊いただけた⽅</p>
        <p><strong>当社の取り扱い商品の特徴</strong><br>
        取り扱いエリア<br>
        ⼊居率や家賃の相場が⾼い【東京・神奈川エリア】の中古区分物件を中⼼に、築年数や駅距離などの条件の良いものをセレクトし、お客様にご提案しています。<br>
        ※⼀部、⼤阪エリア物件の取り扱いあり<br>
        物件ラインナップ<br>
        お客様のニーズにお応えするために、低価格⾼利回り物件からファミリータイプ物件まで、様々な物件を取り扱っています。<br>
        ＜価格帯＞1,000万〜5,000万円程度<br>
        ＜平均利回り＞4%前後</p>
        <p><strong>ご注意</strong><br>
        キャンペーン参加等により被った一切の損害について、当社は責任を負わないものとします。<br>
        当社は、諸事情等により、予告なく本キャンペーンの内容の全部または一部を変更したり、本キャンペーンの適正な運用を確保するために必要と判断した措置を講じることができたり、本キャンペーンを早期に終了したりすることができるものとします。<br>
        当社の意に沿わない場合、お断りの理由については一切お答えが出来ませんのでご了承ください。<br>
        現物でのギフトカードの贈呈はございません。 特典はメールにてお渡し致します（当社指定の⽅法による）。特典付与のタイミングは⾯談から90⽇後頃を想定しております。</p>`,
      submit_button_text: "同意して送信",
      key: "final_consent_given"
    }
  ];

  // JavaScriptの主要な関数群はここに続きます
  // (updateProgressBar, showTypingIndicator, hideTypingIndicator, addMessage, addBotMessage, addUserMessage, scrollToBottom, disableOldChoices, displayChoicesOutsideBubble, setupFinalConsentScreen, askQuestion, handleSingleChoiceClick, toggleMultipleChoiceSelection, handleMultipleChoiceSubmit, handleUserInput, displayErrorMessage, removeErrorMessage, submitDataToGAS, イベントリスナー, 初期化処理)


  function updateProgressBar() {
    const totalQuestions = countTotalEffectiveQuestions(userResponses);
    const progress = totalQuestions > 0 ? (completedEffectiveQuestions / totalQuestions) * 100 : 0;
    progressBar.style.width = Math.min(progress, 100) + '%';
  }

  function countTotalEffectiveQuestions(currentResponses) {
    let count = 0;
    let tempResponses = {...currentResponses};

    for (let i = 0; i < questions.length; i++) {
        const q = questions[i];
        if (q.condition) {
            if (tempResponses[q.condition.key] === undefined || tempResponses[q.condition.key] !== q.condition.value) {
                continue;
            }
        }
        if (q.answer_method === 'text-multi') {
            count += q.sub_questions.length;
        } else {
            count++;
        }
    }
    return count || 1;
  }

  function showTypingIndicator() {
    if (isBotTyping) return;
    isBotTyping = true;
    const indicatorWrapper = document.createElement('div');
    indicatorWrapper.classList.add('message-wrapper', 'bot-message-wrapper', 'typing-indicator-wrapper');
    const botIconDiv = document.createElement('div');
    botIconDiv.className = 'bot-icon';
    if (typeof BOT_ICON_URL !== 'undefined' && BOT_ICON_URL && BOT_ICON_URL !== 'YOUR_BOT_ICON_URL_HERE') {
        botIconDiv.style.backgroundImage = `url('${BOT_ICON_URL}')`;
    }
    indicatorWrapper.appendChild(botIconDiv);
    indicatorWrapper.insertAdjacentHTML('beforeend', `
      <div class="message bot-message typing-indicator">
        <span></span><span></span><span></span>
      </div>
    `);
    chatMessages.appendChild(indicatorWrapper);
    // scrollToBottom(); // メッセージ表示後にスクロールするためここでは呼ばない
  }

  function hideTypingIndicator() {
    const indicatorWrapper = chatMessages.querySelector('.typing-indicator-wrapper');
    if (indicatorWrapper) {
      indicatorWrapper.remove();
    }
    isBotTyping = false;
  }

  function addMessage(messageText, sender, isHtml = false, isError = false) {
    hideTypingIndicator();
    const messageWrapper = document.createElement('div');
    messageWrapper.classList.add('message-wrapper', `${sender}-message-wrapper`);

    if (sender === 'bot') {
      const botIconDiv = document.createElement('div');
      botIconDiv.className = 'bot-icon';
      if (typeof BOT_ICON_URL !== 'undefined' && BOT_ICON_URL && BOT_ICON_URL !== 'YOUR_BOT_ICON_URL_HERE') {
          botIconDiv.style.backgroundImage = `url('${BOT_ICON_URL}')`;
          const img = new Image();
          img.onerror = () => { botIconDiv.style.backgroundColor = '#ccc'; };
          img.src = BOT_ICON_URL;
      }
      messageWrapper.appendChild(botIconDiv);
    }

    const messageElement = document.createElement('div');
    messageElement.classList.add('message', `${sender}-message`);
    if (isError && sender === 'bot') {
        messageElement.classList.add('error-text');
    }

    if (isHtml) {
      messageElement.innerHTML = messageText;
    } else {
      messageElement.textContent = messageText;
    }
    messageWrapper.appendChild(messageElement);
    chatMessages.appendChild(messageWrapper);
    return messageElement;
  }

  function addBotMessage(messageText, isHtml = false, isError = false) {
    showTypingIndicator();
    return new Promise(resolve => {
      setTimeout(() => {
        const msgElem = addMessage(messageText, 'bot', isHtml, isError);
        resolve(msgElem);
      }, 600 + Math.random() * 400);
    });
  }

  function addUserMessage(messageText) {
    const msgElem = addMessage(messageText, 'user');
    // ユーザーメッセージ追加後すぐにスクロール
    setTimeout(() => scrollToBottom(), 0);
  }

  function scrollToBottom() {
    // chatMessages.scrollTop = chatMessages.scrollHeight; // 古い方法
    // 最後の要素が表示されるように、少し遅延させてスクロールする
    setTimeout(() => {
        const lastElement = chatMessages.lastElementChild;
        if (lastElement) {
            lastElement.scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" });
        }
    }, 100); // 100msの遅延。必要に応じて調整。
  }


  function disableOldChoices() {
    if (activeChoicesWrapper) {
      const buttons = activeChoicesWrapper.querySelectorAll('.choice-button');
      buttons.forEach(button => button.disabled = true);
      activeChoicesWrapper = null;
    }
    const allOldChoiceWrappers = chatMessages.querySelectorAll('.choices-area-wrapper');
    allOldChoiceWrappers.forEach(wrapper => {
        if (wrapper !== activeChoicesWrapper) {
             const buttons = wrapper.querySelectorAll('.choice-button');
             buttons.forEach(button => button.disabled = true);
        }
    });
    const finalSubmitBtn = document.getElementById('dynamicFinalSubmitButton');
    if (finalSubmitBtn) finalSubmitBtn.disabled = true;
  }

  function displayChoicesOutsideBubble(question) {
    normalInputArea.style.display = 'none';

    const choicesAreaWrapper = document.createElement('div');
    choicesAreaWrapper.className = 'choices-area-wrapper';
    activeChoicesWrapper = choicesAreaWrapper;

    const choicesContainer = document.createElement('div');
    choicesContainer.className = 'choices-container';
    // ★★★ 選択肢が2つの場合でもデフォルトで2列にするため、force-single-columnのクラス付与ロジックを削除 ★★★
    // if (question.options.length <= 2) {
    //     // choicesContainer.classList.add('force-single-column'); // この行をコメントアウトまたは削除
    // }


    question.options.forEach(option => {
      const button = document.createElement('button');
      button.className = 'choice-button';
      button.textContent = option;
      button.dataset.value = option;
      button.dataset.questionId = question.id;
      choicesContainer.appendChild(button);

      if (question.answer_method === "single-choice") {
        button.addEventListener('click', (event) => handleSingleChoiceClick(event, option, question));
      } else {
        button.addEventListener('click', (event) => toggleMultipleChoiceSelection(event, button, option));
      }
    });

    if (question.answer_method === "multiple-choice") {
      const submitButtonWrapper = document.createElement('div');
      submitButtonWrapper.className = 'submit-choices-button-wrapper';
      const submitBtn = document.createElement('button');
      submitBtn.textContent = "これで決定";
      submitBtn.className = 'choice-button submit-choices-button';
      submitBtn.dataset.questionId = question.id;
      submitBtn.addEventListener('click', (event) => handleMultipleChoiceSubmit(event, question));
      submitButtonWrapper.appendChild(submitBtn);
      choicesContainer.appendChild(submitButtonWrapper);
      currentMultipleChoices = [];
    }

    choicesAreaWrapper.appendChild(choicesContainer);
    chatMessages.appendChild(choicesAreaWrapper);
    setTimeout(() => scrollToBottom(), 0); // 選択肢表示後すぐにスクロール
  }

  function setupFinalConsentScreen(question) {
    normalInputArea.style.display = 'none';

    const consentMessageWrapper = document.createElement('div');
    consentMessageWrapper.classList.add('message-wrapper', 'bot-message-wrapper', 'final-consent-message-area');

    const botIconDiv = document.createElement('div');
    botIconDiv.className = 'bot-icon';
    if (typeof BOT_ICON_URL !== 'undefined' && BOT_ICON_URL && BOT_ICON_URL !== 'YOUR_BOT_ICON_URL_HERE') {
        botIconDiv.style.backgroundImage = `url('${BOT_ICON_URL}')`;
    }
    consentMessageWrapper.appendChild(botIconDiv);

    const consentMessageBubble = document.createElement('div');
    consentMessageBubble.classList.add('message', 'bot-message');
    const privacyPolicyLinkHTML = `<a href="${question.privacy_policy_url}" target="_blank" rel="noopener noreferrer">${question.privacy_policy_link_text}</a>`;
    consentMessageBubble.innerHTML = question.question.replace(question.privacy_policy_link_text, privacyPolicyLinkHTML);
    consentMessageWrapper.appendChild(consentMessageBubble);
    chatMessages.appendChild(consentMessageWrapper);
    // setTimeout(() => scrollToBottom(), 0); // メッセージ表示後すぐにスクロール

    const checkboxAreaWrapper = document.createElement('div');
    checkboxAreaWrapper.className = 'choices-area-wrapper';
    const checkboxArea = document.createElement('div');
    checkboxArea.className = 'final-consent-checkbox-area';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = 'dynamicGiftTermsConsentCheckbox';

    const label = document.createElement('label');
    label.htmlFor = checkbox.id;
    const giftLink = document.createElement('a');
    giftLink.href = "#";
    giftLink.textContent = question.gift_terms_link_text;
    giftLink.id = 'dynamicGiftTermsLink';
    giftLink.addEventListener('click', (e) => {
        e.preventDefault();
        modalBody.innerHTML = question.gift_terms_popup_content;
        giftTermsModal.style.display = 'flex';
    });
    label.appendChild(giftLink);
    label.append(" について同意します。");
    const noteSpan = document.createElement('span');
    noteSpan.style.display = 'block';
    noteSpan.style.fontSize = '0.9em';
    noteSpan.style.color = '#555';
    noteSpan.textContent = '※お申し込み完了後のポイント変更は原則受け付けておりません。予めご了承ください。';
    label.appendChild(noteSpan);

    checkboxArea.appendChild(checkbox);
    checkboxArea.appendChild(label);
    checkboxAreaWrapper.appendChild(checkboxArea)
    chatMessages.appendChild(checkboxAreaWrapper);
    // setTimeout(() => scrollToBottom(), 0); // チェックボックス表示後すぐにスクロール

    const submitButtonAreaWrapper = document.createElement('div');
    submitButtonAreaWrapper.className = 'choices-area-wrapper';
    const finalSubmitButton = document.createElement('button');
    finalSubmitButton.className = 'choice-button submit-choices-button';
    finalSubmitButton.textContent = question.submit_button_text;
    finalSubmitButton.id = 'dynamicFinalSubmitButton';
    finalSubmitButton.disabled = true;

    checkbox.addEventListener('change', () => {
        finalSubmitButton.disabled = !checkbox.checked;
    });

    finalSubmitButton.addEventListener('click', () => {
        if (checkbox.checked) {
            userResponses[question.key] = true;
            disableOldChoices();
            // ★★★ 「ありがとうございます。情報を送信します。」を削除 ★★★
            submitDataToGAS(); // 「情報を送信中...」はsubmitDataToGAS内で表示
            finalSubmitButton.disabled = true;
            checkbox.disabled = true;
        }
    });
    submitButtonAreaWrapper.appendChild(finalSubmitButton);
    chatMessages.appendChild(submitButtonAreaWrapper);
    setTimeout(() => scrollToBottom(), 0); // 最終同意ボタン表示後すぐにスクロール
  }


  function askQuestion() {
    disableOldChoices();
    userInput.disabled = false;
    sendButton.disabled = false;
    normalInputArea.style.display = 'flex';
    userInput.classList.remove('input-error');
    removeErrorMessage();
    updateProgressBar();

    while (currentStep < questions.length) {
        const q = questions[currentStep];
        if (q.condition) {
            const conditionKey = q.condition.key;
            const conditionValue = q.condition.value;
            if (userResponses[conditionKey] === undefined || userResponses[conditionKey] !== conditionValue) {
                currentStep++;
                updateProgressBar();
                continue;
            }
        }
        break;
    }

    if (currentStep >= questions.length) {
      addBotMessage("全ての情報をご入力いただき、ありがとうございました！").then(msgElem => {
          setTimeout(() => scrollToBottom(), 0);
      });
      userInput.disabled = true;
      sendButton.disabled = true;
      normalInputArea.style.display = 'none';
      updateProgressBar();
      return;
    }

    const currentQuestion = questions[currentStep];
    let questionTextToShow = currentQuestion.question;

    if (currentQuestion.answer_method === "final-consent") {
        setupFinalConsentScreen(currentQuestion);
        return;
    }


    if (currentQuestion.answer_method === "text-multi") {
        if (subStep < currentQuestion.sub_questions.length) {
            questionTextToShow = currentQuestion.sub_questions[subStep].label + "を入力してください。";
            userInput.type = currentQuestion.sub_questions[subStep].type || "text";
            userInput.placeholder = currentQuestion.sub_questions[subStep].placeholder || `ここに入力`;
        } else {
            subStep = 0;
            completedEffectiveQuestions += currentQuestion.sub_questions.length;
            currentStep++;
            askQuestion();
            return;
        }
    } else {
        userInput.type = currentQuestion.type || "text";
        userInput.placeholder = currentQuestion.placeholder || `ここに入力`;
    }

    addBotMessage(questionTextToShow).then(messageElement => {
      setTimeout(() => scrollToBottom(), 0); // メッセージ表示後すぐにスクロール
      if (currentQuestion.answer_method === "single-choice" || currentQuestion.answer_method === "multiple-choice") {
        displayChoicesOutsideBubble(currentQuestion);
      } else {
        normalInputArea.style.display = 'flex';
        userInput.style.display = 'flex';
        sendButton.style.display = 'flex';
        userInput.value = '';
        userInput.focus();
      }
    });
  }

  function handleSingleChoiceClick(event, value, question) {
    const clickedButton = event.target;
    if (parseInt(clickedButton.dataset.questionId) !== questions[currentStep].id || clickedButton.disabled) {
        return;
    }
    addUserMessage(value);
    if (question.validation && !question.validation(value)) {
        addBotMessage(question.errorMessage, false, true).then(msgElem => {
            setTimeout(() => scrollToBottom(), 0);
        });
        return;
    }
    userResponses[question.key] = value;
    disableOldChoices();
    completedEffectiveQuestions++;
    currentStep++;
    setTimeout(askQuestion, 300);
  }

  function toggleMultipleChoiceSelection(event, buttonElement, value) {
    if (parseInt(buttonElement.dataset.questionId) !== questions[currentStep].id || buttonElement.disabled) {
        return;
    }
    buttonElement.classList.toggle('selected');
    if (currentMultipleChoices.includes(value)) {
      currentMultipleChoices = currentMultipleChoices.filter(item => item !== value);
    } else {
      currentMultipleChoices.push(value);
    }
  }

  function handleMultipleChoiceSubmit(event, question) {
    const clickedButton = event.target;
    if (parseInt(clickedButton.dataset.questionId) !== questions[currentStep].id || clickedButton.disabled) {
        return;
    }
    if (question.validation && !question.validation(currentMultipleChoices)) {
        addBotMessage(question.errorMessage, false, true).then(msgElem => {
            setTimeout(() => scrollToBottom(), 0);
        });
        return;
    }
    addUserMessage(currentMultipleChoices.length > 0 ? currentMultipleChoices.join(', ') : "(選択なし)");
    userResponses[question.key] = [...currentMultipleChoices];
    currentMultipleChoices = [];
    disableOldChoices();
    completedEffectiveQuestions++;
    currentStep++;
    setTimeout(askQuestion, 300);
  }

  function handleUserInput() {
    const messageText = userInput.value.trim();
    if (messageText === "" || userInput.disabled) return;

    const currentQuestion = questions[currentStep];

    if (currentQuestion.answer_method === "text-multi") {
        const subQ = currentQuestion.sub_questions[subStep];
        if (subQ.validation && !subQ.validation(messageText)) {
            addBotMessage(subQ.errorMessage, false, true).then(msgElem => {
                setTimeout(() => scrollToBottom(), 0);
            });
            userInput.classList.add('input-error');
            displayErrorMessage(subQ.errorMessage);
            userInput.focus();
            return;
        }
        userResponses[subQ.key] = messageText;
        addUserMessage(`${subQ.label}: ${messageText}`);
        subStep++;
    } else {
        if (currentQuestion.validation && !currentQuestion.validation(messageText)) {
            addBotMessage(currentQuestion.errorMessage, false, true).then(msgElem => {
                setTimeout(() => scrollToBottom(), 0);
            });
            userInput.classList.add('input-error');
            displayErrorMessage(currentQuestion.errorMessage);
            userInput.focus();
            return;
        }
        userResponses[currentQuestion.key] = messageText;
        addUserMessage(messageText);
        completedEffectiveQuestions++;
        currentStep++;
    }

    userInput.classList.remove('input-error');
    removeErrorMessage();
    userInput.value = '';
    setTimeout(askQuestion, 300);
  }

  function displayErrorMessage(message) {
    removeErrorMessage();
    const errorDiv = document.createElement('div');
    errorDiv.classList.add('error-message');
    errorDiv.textContent = message;
    userInput.parentNode.insertBefore(errorDiv, userInput.nextSibling);
  }

  function removeErrorMessage() {
    const existingError = userInput.parentNode.querySelector('.error-message');
    if (existingError) {
      existingError.remove();
    }
  }

  function submitDataToGAS() {
    addBotMessage("情報を送信中...").then(msgElem => { // 送信中メッセージ
        setTimeout(() => scrollToBottom(), 0);
    });
    if (typeof GAS_WEB_APP_URL === 'undefined' || !GAS_WEB_APP_URL || GAS_WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
        addBotMessage("データ送信先URLが正しく設定されていません。config.js を確認してください。", false, true).then(msgElem => {
            setTimeout(() => scrollToBottom(), 0);
        });
        console.error("GAS_WEB_APP_URL is not set or is a placeholder in config.js.");
        return;
    }
    fetch(GAS_WEB_APP_URL, {
      method: 'POST',
      mode: 'no-cors',
      cache: 'no-cache',
      body: JSON.stringify(userResponses)
    })
    .then(() => {
      // ★★★ 完了メッセージを変更 ★★★
      addBotMessage("お問い合わせいただきありがとうございました！後ほど担当よりご連絡いたします。").then(msgElem => {
            setTimeout(() => scrollToBottom(), 0);
      });
      normalInputArea.style.display = 'none';
      completedEffectiveQuestions++;
      updateProgressBar();
    })
    .catch(error => {
      console.error('Error sending data to Google Sheet:', error);
      addBotMessage("エラーが発生し、データを送信できませんでした。お手数ですが、時間をおいて再度お試しください。", false, true).then(msgElem => {
            setTimeout(() => scrollToBottom(), 0);
      });
      const finalSubmitBtn = document.getElementById('dynamicFinalSubmitButton');
      if (finalSubmitBtn) finalSubmitBtn.disabled = false;
      const finalCheckbox = document.getElementById('dynamicGiftTermsConsentCheckbox');
      if (finalCheckbox) finalCheckbox.disabled = false;
    });
  }

  sendButton.addEventListener('click', handleUserInput);
  userInput.addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      const currentQuestion = questions[currentStep];
      if (currentQuestion && (currentQuestion.answer_method === "single-choice" || currentQuestion.answer_method === "multiple-choice" || currentQuestion.answer_method === "final-consent")) {
          event.preventDefault();
          return;
      }
      event.preventDefault();
      handleUserInput();
    }
  });

  modalCloseButton.addEventListener('click', () => {
    giftTermsModal.style.display = 'none';
  });
  window.addEventListener('click', (event) => {
    if (event.target == giftTermsModal) {
      giftTermsModal.style.display = 'none';
    }
  });

  setTimeout(() => {
      updateProgressBar();
      if (typeof BOT_ICON_URL === 'undefined' || BOT_ICON_URL === 'YOUR_BOT_ICON_URL_HERE') {
          console.warn("BOT_ICON_URL is not set or is a placeholder in config.js. Default icon behavior will apply.");
      }
      addBotMessage("J.P.Returnsにお問い合わせいただきありがとうございます！").then(msgElem1 => {
        setTimeout(() => scrollToBottom(), 0); // 1つ目のメッセージ後
        return addBotMessage("30秒程度の簡単な質問をさせてください。");
      }).then(msgElem2 => {
        setTimeout(() => scrollToBottom(), 0); // 2つ目のメッセージ後
        setTimeout(askQuestion, 1200);
      });
  }, 500);

</script>
</body>
</html>
